{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content py-5 bg-light">
    <div class="container">

        <header class="section-heading">
            <h3 class="text-center">{{ book.title }}'s reviews</h3>
        </header>        

        <section class="mt-5">
            <h4 class="text-center mb-4">Wanna give your review?</h4>
            <form method="post" action="{% url 'submit_review' book.id %}" id="form" class="form">
                {% csrf_token %}
                
                <div class="mb-4 flex justify-center">
                    <div class="w-1/2">
                        <select name="rating" class="border rounded p-2 w-full">
                            <option value="" disabled selected>How do you rate this book?</option>
                            <option value="1">⭐</option>
                            <option value="2">⭐⭐</option>
                            <option value="3">⭐⭐⭐</option>
                            <option value="4">⭐⭐⭐⭐</option>
                            <option value="5">⭐⭐⭐⭐⭐</option>
                        </select>
                    </div>
                </div>
                
                
                <div class="mb-4 flex justify-center">
                    <textarea name="comment" class="w-1/2 h-32 resize-none border rounded p-2" placeholder="Give your review here..."></textarea>
                </div>

                <div class="d-flex justify-content-center">
                    <input type="button" value="Submit" class="btn btn-primary" id="button_add" onclick="addReview()">
                </div>
            </form>
        </section>
        
        <hr>
        <br>

        <div id="review_list"></div>

    </div>
</section>

<script>
    async function getReviews() {
        return fetch("{% url 'get_review_json' book.id %}").then((res) => res.json())
    }
    

    async function refreshReviews() {
        document.getElementById("review_list").innerHTML = "";
        const reviews = await getReviews();
        let htmlString = ``;
        
        if (reviews.length === 0) {
            htmlString = `<h3 class="text-center">No Review yet</h3>`;
        } else {
            htmlString = `<h4 class="text-center">${reviews.length} review(s)</h4>`;
            
            // Start the row outside of the loop
            htmlString += `<div class="row">`;
            
            reviews.forEach((review, index) => {
                htmlString += `
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title d-inline">${review.user}</h6>
                                    <span class="rating-star ml-2">
                                        ${Array(parseInt(review.rating)).fill().map(() => `⭐`).join('')}
                                    </span>
                                </div>
                                <span class="text-muted">${review.created_at}</span>
                            </div>
                            <p class="card-text mt-2">${review.comment}</p>
                        </div>
                    </div>
                </div>`;
                
                // Close the current row and start a new one after every 3rd review
                if ((index + 1) % 3 === 0 && index !== reviews.length - 1) {
                    htmlString += `</div><div class="row">`;
                }
            });
        
            // Close the last row after loop finishes
            htmlString += `</div>`;
        }
        
        
        document.getElementById("review_list").innerHTML = htmlString;
    }

    function addReview() {
        fetch("{% url 'submit_review_ajax' book.id %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshReviews)

        document.getElementById("form").reset()
        return false
    }

    function getStarClass(rating) {
        if (rating === 0.5) {
            return "-half-o";
        } else if (rating < 1) {
            return "-o";
        } else {
            return "";
        }
    }

    refreshReviews()
    document.getElementById("button_add").onclick = addReview
</script>
{% endblock %}